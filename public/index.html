<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Comm360</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4CAF50',
            secondary: '#2196F3',
            accent: '#FFB300',
            background: '#121212',
            surface: '#1E1E1E',
            text: '#E0E0E0',
            muted: '#757575',
          },
          spacing: { xs: '0.5rem', sm: '1rem', md: '1.5rem', lg: '2rem' },
          borderRadius: { DEFAULT: '0.75rem' }
        }
      }
    }
  </script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Landing page container (shown by default) -->
  <section id="landing-container" class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-surface to-background p-lg">
    <div class="bg-surface bg-opacity-80 rounded-lg shadow-lg p-md max-w-md w-full space-y-md">
      <header class="text-center space-y-xs">
        <h1 class="text-4xl font-semibold text-text">
          <i class="fas fa-video text-primary mr-xs"></i>
          Comm360
        </h1>
        <p class="text-muted text-sm">Simple, secure video conferencing</p>
      </header>
      
      <div class="flex flex-col md:flex-row gap-lg">
        <div class="bg-surface bg-opacity-80 rounded-lg p-md text-center transition-transform transform hover:-translate-y-1">
          <h3>Start a new meeting</h3>
          <p>Create a new room and invite others</p>
          <button id="create-room" class="bg-primary text-white py-sm px-md rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-primary">
            <i class="fas fa-plus-circle"></i> New Meeting
          </button>
        </div>
        
        <div class="bg-surface bg-opacity-80 rounded-lg p-md text-center transition-transform transform hover:-translate-y-1">
          <h3>Join a meeting</h3>
          <p>Enter a room code to join an existing meeting</p>
          <div class="flex gap-xs mb-md">
            <input
              type="text"
              id="room-id-input"
              class="flex-1 bg-surface bg-opacity-80 text-text placeholder:text-muted p-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Room ID"
              aria-label="Room ID"
            >
            <button
              id="join-room"
              class="bg-secondary text-white py-sm px-md rounded-lg hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-secondary"
            >
              <i class="fas fa-sign-in-alt"></i> Join
            </button>
          </div>
        </div>
      </div>
      
      <div id="active-rooms-container" class="active-rooms">
        <h4>Active Rooms</h4>
        <div id="active-rooms-list" class="active-rooms-list">
          <!-- Active rooms will be populated here -->
          <div class="room-loading">Loading available rooms...</div>
        </div>
      </div>
      
      <section class="bg-surface bg-opacity-80 rounded-lg p-md mt-lg space-y-md">
        <h4>Your Settings</h4>
        <div class="flex gap-xs mb-md">
          <span class="bg-surface text-muted px-sm py-xs rounded-l-lg">Display Name</span>
          <input
            type="text"
            id="display-name-input"
            class="flex-1 bg-surface bg-opacity-80 text-text placeholder:text-muted p-sm rounded-r-lg focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Your Name"
          >
        </div>
        <div class="device-preview">
          <div class="camera-preview">
            <video id="camera-preview" autoplay muted playsinline></video>
            <div class="preview-controls">
              <button
                id="toggle-preview-video"
                class="bg-surface bg-opacity-70 p-xs rounded-full hover:bg-opacity-100 focus:outline-none focus:ring-2 focus:ring-primary"
                aria-label="Toggle preview video"
              >
                <i class="fas fa-video text-text"></i>
              </button>
              <button
                id="toggle-preview-audio"
                class="bg-surface bg-opacity-70 p-xs rounded-full hover:bg-opacity-100 focus:outline-none focus:ring-2 focus:ring-primary"
                aria-label="Toggle preview audio"
              >
                <i class="fas fa-microphone text-text"></i>
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </section>
  
  <!-- Main meeting container (hidden by default) -->
  <section
    id="meeting-container"
    class="hidden flex flex-col h-screen bg-background"
    aria-hidden="true"
  >
    <!-- Meeting header with meeting info -->
    <header class="flex items-center justify-between p-md bg-surface border-b border-surface">
      <div class="flex items-center space-x-xs text-text">
        <i class="fa-solid fa-shield-halved text-primary"></i>
        <span id="meeting-name">Room: <span id="meeting-id">...</span></span>
        <button
          id="copy-invite"
          class="ml-xs p-xs rounded focus:outline-none focus:ring-2 focus:ring-primary border border-text text-text"
          title="Copy invite link"
          aria-label="Copy invite link"
        >
          <i class="fas fa-copy"></i>
        </button>
      </div>
      <div class="meeting-duration text-sm font-mono text-text bg-surface bg-opacity-20 px-xs py-xs rounded">
        <span id="meeting-timer">00:00:00</span>
      </div>
      <div class="flex items-center space-x-xs text-text">
        <span id="user-name">...</span>
        <span class="bg-primary text-white px-xs py-0.5 rounded-full text-xs">Host</span>
      </div>
    </header>

    <!-- Main content area -->
    <div class="meeting-content">
      <!-- Incoming call offers will render here -->
      <div id="answer" class="incoming-calls"></div>

      <!-- Main video area with speaker view / gallery view -->
      <div id="video-container" class="flex-1 p-md flex items-center justify-center bg-background">
        <div id="participants-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-md w-full h-full">
          <!-- Grid will be dynamically populated based on participant count -->
          
          <!-- Self view (always present) -->
          <div id="self-video-wrapper" class="relative rounded-lg overflow-hidden bg-surface shadow-lg">
            <video id="local-video" autoplay muted playsinline></video>
            <div class="absolute bottom-0 left-0 w-full bg-black bg-opacity-50 flex items-center justify-between px-xs py-xs">
              <div class="participant-name">You</div>
              <div class="connection-status">
                <i class="fas fa-signal"></i>
              </div>
            </div>
            <div class="absolute top-xs left-xs flex space-x-xs">
              <span class="bg-black bg-opacity-50 text-primary p-xs rounded-full">
                <i class="fas fa-microphone-slash"></i>
              </span>
            </div>
          </div>
          
          <!-- Remote view -->
          <div id="remote-video-wrapper" class="relative rounded-lg overflow-hidden bg-surface shadow-lg">
            <video id="remote-video" autoplay playsinline></video>
            <div class="absolute bottom-0 left-0 w-full bg-black bg-opacity-50 flex items-center justify-between px-xs py-xs">
              <div class="participant-name" id="remote-participant-name">Waiting for participants...</div>
              <div class="connection-status">
                <i class="fas fa-signal"></i>
              </div>
            </div>
            <div class="absolute top-xs left-xs flex space-x-xs">
              <span class="bg-black bg-opacity-50 text-secondary p-xs rounded-full">
                <i class="fas fa-microphone"></i>
              </span>
            </div>
          </div>
          
          <!-- Placeholder for more participants -->
          <div class="flex items-center justify-center bg-surface bg-opacity-50 rounded-lg border-2 border-dashed border-surface h-full">
            <div class="empty-slot-content">
              <i class="fas fa-user-plus"></i>
              <p>Waiting for others to join...</p>
            </div>
          </div>
        </div>
        
        <!-- Speaker view toggle -->
        <div class="view-controls">
          <button id="toggle-grid-view" class="view-toggle">
            <i class="fas fa-th-large"></i> Gallery View
          </button>
        </div>
      </div>

      <!-- Meeting controls toolbar -->
      <div class="flex justify-between items-center p-md bg-surface border-t border-surface">
         <!-- Left controls -->
        <div class="flex space-x-sm">
          <button id="toggle-audio" class="control-button">
            <i class="fas fa-microphone"></i>
            <span class="control-label">Mute</span>
          </button>
          <button id="toggle-video" class="control-button">
            <i class="fas fa-video"></i>
            <span class="control-label">Stop Video</span>
          </button>
        </div>

        <!-- Middle controls -->
        <div class="flex space-x-sm">
          <button id="share-screen" class="control-button">
            <i class="fas fa-desktop"></i>
            <span class="control-label">Share Screen</span>
          </button>
          <button id="chat" class="control-button">
            <i class="fas fa-comment"></i>
            <span class="control-label">Chat</span>
            <span id="unread-messages" class="notification-badge d-none">0</span>
          </button>
          <button id="participants" class="control-button">
            <i class="fas fa-users"></i>
            <span class="control-label">Participants</span>
            <span id="participant-count" class="count-badge">1</span>
          </button>
          <button id="settings" class="control-button">
            <i class="fas fa-cog"></i>
            <span class="control-label">Settings</span>
          </button>
        </div>

        <!-- Right controls -->
        <div class="flex space-x-sm">
          <button id="call" class="control-button join-button">
            <i class="fas fa-phone"></i>
            <span class="control-label">Join</span>
          </button>
          <button id="hangup" class="control-button leave-button" disabled>
            <i class="fas fa-phone-slash"></i>
            <span class="control-label">Leave</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Chat sidebar (hidden by default) -->
    <aside
      id="chat-sidebar"
      class="fixed top-0 right-0 h-full w-80 bg-surface shadow-xl transform translate-x-full transition-transform duration-300"
      aria-hidden="true"
    >
      <div class="sidebar-header">
        <h5>In-Meeting Chat</h5>
        <button id="close-chat" class="close-sidebar"><i class="fa-solid fa-times"></i></button>
      </div>
      <div id="chat-messages" class="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chat-input" placeholder="Type message here..." class="chat-input">
        <button id="send-chat" class="send-chat-btn"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </aside>

    <!-- Participants sidebar (hidden by default) -->
    <aside
      id="participants-sidebar"
      class="fixed top-0 right-0 h-full w-80 bg-surface shadow-xl transform translate-x-full transition-transform duration-300"
      aria-hidden="true"
    >
      <div class="sidebar-header">
        <h5>Participants (2)</h5>
        <button id="close-participants" class="close-sidebar"><i class="fa-solid fa-times"></i></button>
      </div>
      <div class="participants-list">
        <div class="participant-item">
          <div class="participant-info">
            <span class="participant-name">You (Host)</span>
          </div>
          <div class="participant-controls">
            <i class="fa-solid fa-microphone"></i>
            <i class="fa-solid fa-video"></i>
          </div>
        </div>
        <div id="remote-participant" class="participant-item">
          <div class="participant-info">
            <span id="remote-user-name" class="participant-name">Waiting...</span>
          </div>
          <div class="participant-controls">
            <i class="fa-solid fa-microphone"></i>
            <i class="fa-solid fa-video"></i>
          </div>
        </div>
      </div>
    </aside>
  </section>
  
  <!-- Settings modal (Tailwind) -->
  <div
    id="settings-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden"
    role="dialog" aria-modal="true"
    aria-hidden="true"
  >
    <div class="bg-surface rounded-lg shadow-xl w-11/12 max-w-md overflow-hidden">
      <!-- Header -->
      <header class="flex justify-between items-center p-md border-b border-surface">
        <h2 id="settingsModalLabel" class="text-lg font-medium text-text">Meeting Settings</h2>
        <button
          id="close-settings"
          class="text-text hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary p-xs rounded"
          aria-label="Close settings"
        >
          <i class="fa-solid fa-xmark"></i>
        </button>
      </header>

      <!-- Body -->
      <div class="p-md space-y-md">
        <div>
          <label for="audio-input-select" class="block text-text mb-xs">Microphone</label>
          <select
            id="audio-input-select"
            class="w-full bg-surface bg-opacity-80 text-text p-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          ></select>
        </div>
        <div>
          <label for="video-input-select" class="block text-text mb-xs">Camera</label>
          <select
            id="video-input-select"
            class="w-full bg-surface bg-opacity-80 text-text p-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          ></select>
        </div>
        <div id="audio-output-container">
          <label for="audio-output-select" class="block text-text mb-xs">Audio Output</label>
          <select
            id="audio-output-select"
            class="w-full bg-surface bg-opacity-80 text-text p-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
          ></select>
        </div>
        <div>
          <label class="block text-text mb-xs">Preview</label>
          <video
            id="settings-video-preview"
            class="w-full rounded-lg bg-black"
            autoplay muted playsinline
          ></video>
        </div>
      </div>

      <!-- Footer -->
      <footer class="flex justify-end space-x-sm p-md border-t border-surface">
        <button
          id="cancel-settings"
          class="px-md py-sm rounded-lg bg-surface hover:bg-surface/80 focus:outline-none focus:ring-2 focus:ring-primary"
        >
          Close
        </button>
        <button
          id="apply-settings"
          class="px-md py-sm rounded-lg bg-primary text-white hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary"
        >
          Apply
        </button>
      </footer>
    </div>
  </div>

  <!-- Removed Bootstrap JS (modal replaced by Tailwind) -->
  
  <!-- Socket.io client library -->
  <script src="https://cdn.socket.io/4.6.2/socket.io.min.js"></script>

  <!-- Inject your signaling server URL here -->
  <script>
    // window.SIGNALING_SERVER_URL = 'http://localhost:8181';
    window.SIGNALING_SERVER_URL = 'https://webrtc-signaling-server-8t73.onrender.com';
    window.MEETING_ID = null; // Will be set upon room creation/joining
  </script>

  <!-- Load your module (which itself imports socketListeners.js) -->
  <script type="module" src="/scripts.js"></script>
</body>
</html>
